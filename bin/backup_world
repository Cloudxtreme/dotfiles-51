#!/usr/bin/env bash

# master backup job:
# - delete local dropbox cache
# - rsync local dropbox to remote NAS
# - rsync remote NAS to local mirror


set -e


function purge-dropbox-cache () {
    dropbox stop
    cache_dir=~/Dropbox/.dropbox.cache/
    if [ -e $cache_dir ]; then
        du -h $cache_dir
        rm -rf $cache_dir
    fi
    dropbox start
}


if [[ $HOSTNAME != "collosus" ]]; then
    echo "sorry, this script can only be run on colossus"
    exit 1
fi

if [ ! -d /mnt/bytez/ ]; then
    echo "error: can't find mount point for remote NAS (bytez)"
    exit 1
fi

if [ ! -d /mnt/wd-green/ ]; then
    echo "error: can't find mount point for secondary local HDD mirror (wd-green)"
    exit 1
fi

if [ ! -d ~/Dropbox/ ]; then
    echo "error: can't find local Dropbox"
    exit 1
fi


SEP="----------------------------------------------------------------"

echo
echo "starting master backup job..."
echo
echo $SEP
echo "purging local dropbox cache..."
echo
purge-dropbox-cache
echo
echo $SEP
echo "syncing local dropbox to remote NAS..."
echo
rsync -a --delete --human-readable --info=progress2 --safe-links ~/Dropbox/ /mnt/bytez/Dropbox/
echo
echo $SEP
echo "syncing remote NAS to local mirror..."
echo
rsync -a --delete --human-readable --progress --info=progress2 --safe-links /mnt/bytez/ /mnt/wd-green/
echo
echo $SEP
echo "flushing local file system buffers (synchronize cached writes)..."
sync
echo
echo $SEP
echo "stats:"
echo
df -hT --total --type=ext4 --type=cifs
echo
echo "NAS (bytez):"
tree /mnt/bytez/ | tail -n 1
echo
echo "local mirror (wd-green):"
tree /mnt/wd-green/ | tail -n 1
echo $SEP
echo
echo "done"
